<!DOCTYPE html>
<html>

<head>
    <title>Palindrome Editor</title>
    <style>
        html,
        body {
            height: 100%;
            padding: 0px;
            margin: 0px;
            overflow: hidden;
            box-sizing: border-box;
        }

        textarea {
            font-family: monospace;
            box-sizing: border-box;
            font-size: 2em;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <textarea id="input" rows="4" cols="50"></textarea>

    <script type="text/javascript">

        function charEdits(handler, initial = "") {
            let lastValue = initial;

            return function (event) {
                const textarea = event.target;
                const currentValue = textarea.value;

                let change = null;
                let start = 0;
                let end = 0;
                let currentEditText = null;
                let lastEditText = null;

                let lastSpan;
                let currentSpan;

                if (lastValue === currentValue) {
                    // No change
                } else if (lastValue.length == currentValue.length) {
                    currentSpan = lastSpan = [textarea.selectionStart - 1, textarea.selectionStart]
                    change = "replace"
                } else if (lastValue.length > currentValue.length) {
                    currentSpan = [textarea.selectionStart, textarea.selectionStart]
                    lastSpan = [textarea.selectionStart, textarea.selectionStart + 1]
                    change = "delete"
                } else if (lastValue.length < currentValue.length) {
                    currentSpan = [textarea.selectionStart - 1, textarea.selectionStart]
                    lastSpan = [textarea.selectionStart - 1, textarea.selectionStart - 1]
                    change = "insert";
                }

                const memorizeLast = lastValue
                lastValue = currentValue;
                // Emit your own custom event here, or handle the change in whatever way you need
                change && handler({
                    change,
                    current: {
                        text: currentValue,
                        span: currentSpan
                    },
                    prev: {
                        text: memorizeLast,
                        span: lastSpan
                    },
                    target: event.target,
                    update: (v) => { lastValue = v }
                });
            }
        }

        function alphabetOnly(v) {
            return v.replace(/[^a-z]/g, '');
        }

        function palindromeHandler(edit) {
            // Concatenate oldText and newText and filter out non-alphabetic characters
            const currSpan = edit.current.text.slice(...edit.current.span)
            const prevSpan = edit.prev.text.slice(...edit.prev.span)
            const concatenatedText = currSpan + prevSpan;
            const alphabeticConcatenated = alphabetOnly(concatenatedText);

            // Ignore the event if there are no alphabetic characters in the change
            if (!alphabeticConcatenated.length) {
                return;
            }

            const textarea = edit.target;

            // Find the index of the change in the alphabetic text

            function findMirrorIndex(normalIndex, text, insert) {
                const alphabeticText = alphabetOnly(text);
                let alphaIndex = 0;
                for (let i = 0; i < normalIndex; i++) {
                    if (text[i].match(/[a-z]/)) {
                        alphaIndex++;
                    }
                }

                let fromStart = alphaIndex;
                let fromEnd = alphabeticText.length - alphaIndex - 1;

                function countFrom(anchorIndex, step) {
                    let steps = 0;
                    for (let i = step === 1 ? 0 : text.length - 1; step === 1 ? i < text.length : i >= 0; i += step) {
                        if (text[i].match(/[a-z]/)) {
                            if (steps === anchorIndex) {
                                return i;
                            }
                            steps++;
                        }
                    }
                    return -1;
                }

                if (fromStart < fromEnd || (fromStart == fromEnd)) {
                    return [countFrom(fromStart, -1), true]
                } else {
                    return [countFrom(fromEnd, 1), false]
                }
            }

            if (edit.change === 'insert') {
                const [mirror, firstHalf] = findMirrorIndex(edit.current.span[0], edit.current.text, true)
                const s = textarea.selectionStart;
                if (firstHalf) {
                    textarea.value = textarea.value.slice(0, mirror + 1) + currSpan + textarea.value.slice(mirror + 1,)
                    textarea.selectionStart = textarea.selectionEnd = s
                } else {
                    textarea.value = textarea.value.slice(0, mirror) + currSpan + textarea.value.slice(mirror,)
                    textarea.selectionStart = textarea.selectionEnd = s + 1
                }
            } else if (edit.change === 'delete') {
                const [mirror, firstHalf] = findMirrorIndex(edit.prev.span[0], edit.prev.text, false)
                const s = textarea.selectionStart;
                if (firstHalf) {
                    textarea.value = textarea.value.slice(0, mirror - 1) + textarea.value.slice(mirror,)
                    textarea.selectionStart = textarea.selectionEnd = s
                } else {
                    textarea.value = textarea.value.slice(0, mirror) + textarea.value.slice(mirror + 1,)
                    textarea.selectionStart = textarea.selectionEnd = s - 1
                }
            }
            edit.update(textarea.value)
        }
        const placeholder = "a man, a plan, a Canal, panama!"
        const handler = charEdits(palindromeHandler, placeholder)
        const textarea = document.querySelector('textarea');
        textarea.value = placeholder;
        textarea.addEventListener('input', handler);
    </script>
</body>

</html>